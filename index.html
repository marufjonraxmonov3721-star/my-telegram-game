<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raxmonov Gold Clicker</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #ffd700; --bg: #0b0e11; --card: #1c2127; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; align-items: center; height: 100vh; overflow: hidden; }
        
        /* Stats */
        .header { margin-top: 30px; text-align: center; }
        #score { font-size: 45px; font-weight: 900; color: var(--gold); text-shadow: 0 0 15px rgba(255, 215, 0, 0.4); margin: 0; }
        .currency-name { font-size: 14px; color: var(--gold); letter-spacing: 2px; }

        /* Game Area */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; width: 100%; position: relative; }
        .coin-btn { width: 200px; height: 200px; background: radial-gradient(circle, #ffe066, #b8860b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 100px; cursor: pointer; box-shadow: 0 0 40px rgba(255, 215, 0, 0.2); border: 6px solid #ffd700; transition: transform 0.05s; }
        .coin-btn:active { transform: scale(0.92); }

        /* Floating Text */
        .plus-one { position: absolute; color: var(--gold); font-size: 24px; font-weight: bold; animation: floatUp 0.7s forwards; pointer-events: none; }
        @keyframes floatUp { 0% { opacity: 1; transform: translateY(0); } 100% { opacity: 0; transform: translateY(-100px); } }

        /* Bottom Controls */
        .bottom-nav { width: 100%; background: var(--card); border-radius: 20px 20px 0 0; padding: 15px 0; display: grid; grid-template-columns: repeat(4, 1fr); gap: 5px; border-top: 2px solid #333; }
        .nav-item { text-align: center; cursor: pointer; }
        .nav-item span { font-size: 10px; color: #aaa; display: block; }
        .nav-item b { font-size: 12px; color: var(--gold); }

        /* Modal / Chat / Shop */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); display: none; flex-direction: column; align-items: center; z-index: 100; padding: 20px 0; }
        .content-box { width: 90%; background: var(--card); border-radius: 15px; padding: 15px; overflow-y: auto; flex-grow: 1; margin-bottom: 20px; }
        .close-btn { background: #e74c3c; border: none; padding: 10px 20px; border-radius: 10px; color: white; font-weight: bold; }

        /* Chat Styles */
        #chat-messages { height: 300px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { font-size: 13px; background: #2c3e50; padding: 8px; border-radius: 10px; }
        .msg b { color: var(--gold); }
        .chat-input { display: flex; gap: 5px; margin-top: 10px; }
        .chat-input input { flex-grow: 1; background: #0b0e11; border: 1px solid #444; color: white; padding: 10px; border-radius: 10px; }

        /* Shop Styles */
        .shop-item { background: #2c3e50; margin-bottom: 10px; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; }
        .buy-btn { background: var(--gold); color: black; border: none; padding: 8px 15px; border-radius: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div class="header">
        <div class="currency-name">RAXMONOV GOLD</div>
        <h1 id="score">0</h1>
        <div style="font-size: 12px; margin-top: 5px; color: #27ae60;">âš¡ <span id="energy-text">1000/1000</span></div>
    </div>

    <div class="game-area">
        <div class="coin-btn" id="tapBtn">ðŸª™</div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="openPanel('shop')"><span>Botlar</span><b>Magazin</b></div>
        <div class="nav-item" onclick="openPanel('chat')"><span>Chat</span><b>Global</b></div>
        <div class="nav-item" onclick="openPanel('ref')"><span>Do'stlar</span><b>Referal</b></div>
        <div class="nav-item" onclick="claimDaily()"><span>Bonus</span><b id="daily-btn">Olish</b></div>
    </div>

    <div id="overlay" class="overlay">
        <h2 id="panel-title" style="color: var(--gold);">Sarlavha</h2>
        <div class="content-box" id="panel-content"></div>
        <button class="close-btn" onclick="closePanel()">Yopish</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            projectId: "gen-lang-client-0228947349",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
            messagingSenderId: "253793341504",
            appId: "1:253793341504:web:709752258000dab44fcfa5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        tg.expand();

        const user = tg.initDataUnsafe?.user || { id: "dev", first_name: "Developer" };
        const startParam = tg.initDataUnsafe?.start_param; // Referal ID
        const userRef = db.ref('users/' + user.id);

        let score = 0, multi = 1, energy = 1000, lastDaily = 0, autoLevel = 0, lastCheck = Date.now();

        // 1. DATA SYNC & AUTO-FARMER
        userRef.on('value', (snap) => {
            const data = snap.val();
            if(data) {
                score = data.score || 0;
                multi = data.multi || 1;
                energy = data.energy || 1000;
                lastDaily = data.lastDaily || 0;
                autoLevel = data.autoLevel || 0;
                
                // Offline Mining Hisoblash
                if(data.lastCheck && autoLevel > 0) {
                    const diffSeconds = Math.floor((Date.now() - data.lastCheck) / 1000);
                    const mined = diffSeconds * (autoLevel * 0.5); // Har level uchun sekundiga 0.5 Raxmonov
                    if(mined > 0) {
                        score += mined;
                        userRef.update({ score: score, lastCheck: Date.now() });
                        if(mined > 1) tg.showAlert("Siz yo'qligingizda botlar " + Math.floor(mined) + " Raxmonov yig'di!");
                    }
                }

                document.getElementById('score').innerText = Math.floor(score).toLocaleString();
                document.getElementById('energy-text').innerText = energy + "/1000";
            } else {
                // Yangi foydalanuvchi bo'lsa va referal orqali kelgan bo'lsa
                userRef.set({ name: user.first_name, score: 0, multi: 1, energy: 1000, autoLevel: 0, lastCheck: Date.now() });
                if(startParam && startParam != user.id) {
                    db.ref('users/' + startParam).transaction(u => {
                        if(u) { u.score += 50000; }
                        return u;
                    });
                }
            }
        });

        // 2. TAP FUNCTION
        document.getElementById('tapBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            if(energy >= multi) {
                score += multi; energy -= multi;
                userRef.update({ score: score, energy: energy, lastCheck: Date.now() });
                createPlusText(e.touches[0].clientX, e.touches[0].clientY);
                if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('medium');
            }
        });

        function createPlusText(x, y) {
            const el = document.createElement('div');
            el.className = 'plus-one'; el.innerText = '+' + multi;
            el.style.left = x + 'px'; el.style.top = y + 'px';
            document.body.appendChild(el);
            setTimeout(() => el.remove(), 700);
        }

        // 3. PANELS (Magazin, Chat, Ref)
        function openPanel(type) {
            const overlay = document.getElementById('overlay');
            const title = document.getElementById('panel-title');
            const content = document.getElementById('panel-content');
            overlay.style.display = 'flex';
            content.innerHTML = '';

            if(type === 'shop') {
                title.innerText = "Mining Botlar";
                const bots = [
                    {lvl: 1, price: 10000, speed: "50/soat"},
                    {lvl: 2, price: 50000, speed: "200/soat"},
                    {lvl: 3, price: 200000, speed: "1000/soat"}
                ];
                bots.forEach(b => {
                    content.innerHTML += `<div class="shop-item">
                        <div><b>Bot Lvl ${b.lvl}</b><br><small>${b.speed}</small></div>
                        <button class="buy-btn" onclick="buyBot(${b.lvl}, ${b.price})">${b.price}</button>
                    </div>`;
                });
            } else if(type === 'chat') {
                title.innerText = "Global Chat";
                content.innerHTML = `<div id="chat-messages"></div>
                    <div class="chat-input"><input id="msgInput" placeholder="Xabar..."><button class="buy-btn" onclick="sendChat()">></button></div>`;
                loadChat();
            } else if(type === 'ref') {
                title.innerText = "Referal Tizimi";
                const link = `https://t.me/BOTINGIZ_NOM_BOT/app?startapp=${user.id}`;
                content.innerHTML = `<div style="text-align:center;">
                    <p>Har bir do'st uchun <b>50,000 Raxmonov</b>!</p>
                    <input value="${link}" readonly style="width:100%; padding:10px; background:#000; color:var(--gold); border:none; border-radius:10px;">
                    <button class="buy-btn" style="margin-top:15px; width:100%;" onclick="tg.openTelegramLink('https://t.me/share/url?url=${link}')">DO'STLARGA YUBORISH</button>
                </div>`;
            }
        }

        // 4. AUTO-BOT SOTIB OLISH
        window.buyBot = (lvl, price) => {
            if(score >= price) {
                userRef.update({ score: score - price, autoLevel: lvl });
                tg.showAlert("Bot Lvl " + lvl + " sotib olindi!");
                closePanel();
            } else tg.showAlert("Mablag' yetarli emas!");
        }

        // 5. CHAT FUNCTION
        function sendChat() {
            const input = document.getElementById('msgInput');
            if(input.value.trim() != "") {
                db.ref('messages').push({ name: user.first_name, text: input.value, time: Date.now() });
                input.value = "";
            }
        }
        function loadChat() {
            db.ref('messages').limitToLast(20).on('value', snap => {
                const box = document.getElementById('chat-messages');
                if(!box) return;
                box.innerHTML = '';
                snap.forEach(m => {
                    const d = m.val();
                    box.innerHTML += `<div class="msg"><b>${d.name}:</b> ${d.text}</div>`;
                });
                box.scrollTop = box.scrollHeight;
            });
        }

        function closePanel() { document.getElementById('overlay').style.display = 'none'; }
        
        // 6. ENERGY & DAILY
        setInterval(() => { if(energy < 1000) { energy = Math.min(1000, energy + 5); userRef.update({ energy: energy }); } }, 3000);
        function claimDaily() {
            const now = Date.now();
            if(now > lastDaily + 86400000) {
                userRef.update({ score: score + 10000, lastDaily: now });
                tg.showAlert("10,000 Raxmonov bonus olindi!");
            } else tg.showAlert("Hali vaqt bor!");
        }
    </script>
</body>
</html>
