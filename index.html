<!DOCTYPE html>
<html lang="uz">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Raxmonov Gold: Deep Control</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>

    <style>
        :root { --gold: #ffd700; --bg: #0b0e11; --card: #1c2127; --green: #27ae60; --red: #e74c3c; }
        body { background-color: var(--bg); color: white; font-family: 'Segoe UI', sans-serif; margin: 0; display: flex; flex-direction: column; height: 100vh; overflow: hidden; }
        
        /* Stats */
        .header { padding: 15px; text-align: center; background: linear-gradient(0deg, transparent, rgba(255,215,0,0.1)); }
        #score { font-size: 45px; font-weight: 900; color: var(--gold); margin: 0; }
        
        /* Main UI */
        .game-area { flex-grow: 1; display: flex; align-items: center; justify-content: center; position: relative; }
        .coin-btn { width: 200px; height: 200px; background: radial-gradient(circle, #ffe066, #b8860b); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 90px; cursor: pointer; box-shadow: 0 0 40px rgba(255, 215, 0, 0.2); border: 8px solid #ffd700; transition: 0.05s; }
        .coin-btn:active { transform: scale(0.95); }

        /* Navigation */
        .bottom-nav { width: 100%; background: var(--card); padding: 10px 0; display: grid; grid-template-columns: repeat(5, 1fr); border-top: 1px solid #333; }
        .nav-item { text-align: center; cursor: pointer; font-size: 10px; color: #aaa; }
        .nav-item i { font-size: 20px; display: block; margin-bottom: 2px; }

        /* Registration Form */
        #reg-form { position: fixed; top:0; left:0; width:100%; height:100%; background: var(--bg); z-index: 2000; display:none; flex-direction: column; align-items: center; justify-content: center; padding: 20px; box-sizing: border-box; }
        
        /* Modals */
        .overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.98); display: none; flex-direction: column; align-items: center; z-index: 1000; padding-top: 20px; }
        .content-box { width: 90%; background: var(--card); border-radius: 15px; padding: 15px; overflow-y: auto; flex-grow: 1; border: 1px solid #333; box-sizing: border-box; }
        
        /* Admin Elements */
        .admin-tag { position: fixed; top: 10px; right: 10px; background: var(--red); font-size: 10px; padding: 5px 10px; border-radius: 5px; z-index: 1001; cursor: pointer; }
        input, select, textarea { width: 100%; padding: 12px; margin-bottom: 10px; background: #000; border: 1px solid #444; color: #fff; border-radius: 8px; font-size: 14px; }
        .btn { background: var(--gold); color: #000; border: none; padding: 12px; border-radius: 8px; font-weight: bold; width: 100%; cursor: pointer; }
        .dosye-card { background: #161b22; border: 1px solid #30363d; padding: 10px; border-radius: 10px; margin-bottom: 10px; font-size: 12px; }
    </style>
</head>
<body>

    <div id="reg-form">
        <h2 style="color: var(--gold);">Ro'yxatdan o'tish</h2>
        <p style="font-size: 12px; color: #888; text-align: center;">O'yinni davom ettirish uchun barcha ma'lumotlarni to'liq kiriting (Admin tekshiruvi uchun).</p>
        <input id="reg-age" type="number" placeholder="Yoshingiz">
        <input id="reg-phone" type="tel" placeholder="Telefon raqamingiz (+998...)">
        <select id="reg-city">
            <option value="">Viloyatni tanlang</option>
            <option value="Toshkent">Toshkent</option>
            <option value="Samarqand">Samarqand</option>
            <option value="Buxoro">Buxoro</option>
            <option value="Farg'ona">Farg'ona</option>
            <option value="Namangan">Namangan</option>
            <option value="Andijon">Andijon</option>
            <option value="Xorazm">Xorazm</option>
            <option value="Qashqadaryo">Qashqadaryo</option>
            <option value="Surxondaryo">Surxondaryo</option>
            <option value="Navoiy">Navoiy</option>
            <option value="Jizzax">Jizzax</option>
            <option value="Sirdaryo">Sirdaryo</option>
            <option value="Qoraqalpog'iston">Qoraqalpog'iston</option>
        </select>
        <textarea id="reg-bio" placeholder="O'zingiz haqingizda qisqacha..."></textarea>
        <button class="btn" onclick="submitReg()">SAQLASH VA KIRISH</button>
    </div>

    <div id="admin-access" class="admin-tag" onclick="openPanel('admin')" style="display:none;">‚öôÔ∏è ADMIN</div>

    <div class="header">
        <h1 id="score">0</h1>
        <div style="font-size: 10px; color: var(--green);">‚óè SYSTEM SECURE | ONLINE: <span id="online-users">1</span></div>
    </div>

    <div class="game-area">
        <div class="coin-btn" id="tapBtn">ü™ô</div>
    </div>

    <div class="bottom-nav">
        <div class="nav-item" onclick="openPanel('profile')"><i>üë§</i>Profil</div>
        <div class="nav-item" onclick="openPanel('mining')"><i>‚õèÔ∏è</i>Fermalar</div>
        <div class="nav-item" onclick="openPanel('transfer')"><i>üí∏</i>Transfer</div>
        <div class="nav-item" onclick="openPanel('rank')"><i>üèÜ</i>Top</div>
        <div class="nav-item" onclick="openPanel('rules')"><i>üìú</i>Qoidalar</div>
    </div>

    <div id="overlay" class="overlay">
        <div class="modal-header">
            <h2 id="panel-title" style="color: var(--gold); margin: 0;">Sarlavha</h2>
            <button onclick="closePanel()" style="background:none; border:none; color:white; font-size:24px;">√ó</button>
        </div>
        <div class="content-box" id="panel-content"></div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBc7tUey3q6hGZjWxisJo701-G4NbyD9zI",
            authDomain: "gen-lang-client-0228947349.firebaseapp.com",
            projectId: "gen-lang-client-0228947349",
            databaseURL: "https://gen-lang-client-0228947349-default-rtdb.firebaseio.com",
            storageBucket: "gen-lang-client-0228947349.firebasestorage.app",
            messagingSenderId: "253793341504",
            appId: "1:253793341504:web:709752258000dab44fcfa5"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const tg = window.Telegram.WebApp;
        tg.expand();

        const ADMIN_ID = 7385372033; 
        const tgUser = tg.initDataUnsafe?.user || { id: 12345, first_name: "Test" };
        const userRef = db.ref('users/' + tgUser.id);
        
        let score = 0, userData = null;

        if(tgUser.id == ADMIN_ID) document.getElementById('admin-access').style.display = 'block';

        // Ma'lumotlarni tekshirish
        userRef.on('value', snap => {
            userData = snap.val();
            if(!userData) {
                document.getElementById('reg-form').style.display = 'flex';
            } else {
                if(userData.banned) {
                    document.body.innerHTML = "<h1 style='color:red; text-align:center; padding-top:100px;'>Siz BLOKLANGANSIZ! ‚ùå</h1>";
                    return;
                }
                document.getElementById('reg-form').style.display = 'none';
                score = userData.score || 0;
                updateUI();
            }
        });

        function updateUI() { document.getElementById('score').innerText = Math.floor(score).toLocaleString(); }

        function submitReg() {
            const age = document.getElementById('reg-age').value;
            const phone = document.getElementById('reg-phone').value;
            const city = document.getElementById('reg-city').value;
            const bio = document.getElementById('reg-bio').value;

            if(!age || !phone || !city) return alert("Iltimos, barcha maydonlarni to'ldiring!");

            userRef.set({
                id: tgUser.id,
                name: tgUser.first_name + " " + (tgUser.last_name || ""),
                username: tgUser.username ? "@" + tgUser.username : "Yo'q",
                age: age,
                phone: phone,
                city: city,
                bio: bio,
                score: 0,
                banned: false,
                regDate: new Date().toLocaleString()
            });
        }

        // Tap
        document.getElementById('tapBtn').addEventListener('touchstart', (e) => {
            e.preventDefault();
            score += 1;
            userRef.update({ score: score });
            if(tg.HapticFeedback) tg.HapticFeedback.impactOccurred('light');
        });

        function openPanel(type) {
            const overlay = document.getElementById('overlay');
            const content = document.getElementById('panel-content');
            const title = document.getElementById('panel-title');
            overlay.style.display = 'flex';
            content.innerHTML = 'Yuklanmoqda...';

            if(type === 'profile') {
                title.innerText = "Sizning Profilingiz";
                content.innerHTML = `
                    <div class="dosye-card">
                        <b>Ism:</b> ${userData.name}<br>
                        <b>ID:</b> ${userData.id}<br>
                        <b>Yoshi:</b> ${userData.age}<br>
                        <b>Tel:</b> ${userData.phone}<br>
                        <b>Manzil:</b> ${userData.city}<br>
                        <b>Ro'yxatdan o'tgan:</b> ${userData.regDate}
                    </div>
                    <button class="btn" style="background:#555; color:#fff;" onclick="tg.close()">ILOVADAN CHIQISH</button>
                `;
            } else if(type === 'admin') {
                title.innerText = "Deep Admin Control";
                content.innerHTML = `
                    <h4>üîç O'yinchi qidirish (ID orqali)</h4>
                    <input id="searchId" placeholder="ID kiriting...">
                    <button class="btn" onclick="inspectUser()">TEKSHIRISH</button>
                    <div id="inspectResult" style="margin-top:15px;"></div>
                    <hr style="border:0.5px solid #333; margin:20px 0;">
                    <h4 style="color:var(--red);">üö® Shubhali Harakatlar</h4>
                    <div id="violationList"></div>
                `;
                loadViolations();
            } else if(type === 'transfer') {
                title.innerText = "Ball O'tkazish";
                content.innerHTML = `
                    <input id="recID" placeholder="Qabul qiluvchi ID raqami...">
                    <input id="recAmt" type="number" placeholder="Soni (min 1000)...">
                    <button class="btn" onclick="processTransfer()">YUBORISH</button>
                `;
            } else if(type === 'rank') {
                title.innerText = "Top 10 Reyting";
                db.ref('users').orderByChild('score').limitToLast(10).once('value', s => {
                    content.innerHTML = '';
                    let p = []; s.forEach(c => p.push(c.val()));
                    p.reverse().forEach((x, i) => {
                        content.innerHTML += `<div class="dosye-card" style="display:flex; justify-content:space-between;">
                            <span>${i+1}. ${x.name}</span><b>${Math.floor(x.score).toLocaleString()}</b>
                        </div>`;
                    });
                });
            }
        }

        // Admin: O'yinchini tekshirish
        function inspectUser() {
            const id = document.getElementById('searchId').value;
            if(!id) return;
            db.ref('users/' + id).once('value', s => {
                const res = document.getElementById('inspectResult');
                if(!s.exists()) return res.innerHTML = "Topilmadi!";
                const d = s.val();
                res.innerHTML = `
                    <div class="dosye-card" style="border: 1px solid var(--gold);">
                        <b style="color:var(--gold);">Batafsil Dosye:</b><br>
                        FIO: ${d.name}<br>
                        Username: ${d.username}<br>
                        Yoshi: ${d.age} | Tel: ${d.phone}<br>
                        Manzil: ${d.city}<br>
                        Ball: ${Math.floor(d.score).toLocaleString()}<br>
                        Bio: ${d.bio}<br><br>
                        <button class="btn" style="background:var(--red); color:#fff;" onclick="banUser('${id}')">${d.banned ? 'OCHISH' : 'BLOKLASH'}</button>
                    </div>
                `;
            });
        }

        function banUser(id) {
            db.ref('users/' + id + '/banned').once('value', s => {
                db.ref('users/' + id).update({ banned: !s.val() });
                tg.showAlert("Amal bajarildi!");
                inspectUser();
            });
        }

        function processTransfer() {
            const rid = document.getElementById('recID').value.trim();
            const amt = parseInt(document.getElementById('recAmt').value);
            if(rid == tgUser.id) return tg.showAlert("O'zingizga ball o'tkaza olmaysiz!");
            if(!rid || amt < 1000 || score < amt) return tg.showAlert("Ma'lumot xato yoki ball yetarli emas!");

            db.ref('users/' + rid).once('value', s => {
                if(s.exists()) {
                    userRef.update({ score: score - amt });
                    db.ref('users/' + rid).update({ score: (s.val().score || 0) + amt });
                    tg.showAlert("Ballar muvaffaqiyatli o'tkazildi!");
                    closePanel();
                } else tg.showAlert("Bunday ID dagi o'yinchi topilmadi!");
            });
        }

        function loadViolations() {
            db.ref('violations').limitToLast(10).on('value', s => {
                const div = document.getElementById('violationList');
                if(!div) return;
                div.innerHTML = '';
                s.forEach(v => {
                    const d = v.val();
                    div.innerHTML += `<div class="dosye-card" style="border-left: 3px solid var(--red);">
                        <b>${d.name}</b>: ${d.reason}<br><small>${d.time}</small>
                    </div>`;
                });
            });
        }

        // Online system
        db.ref('online/'+tgUser.id).set(true); db.ref('online/'+tgUser.id).onDisconnect().remove();
        db.ref('online').on('value', s => document.getElementById('online-users').innerText = s.numChildren());

        function closePanel() { document.getElementById('overlay').style.display = 'none'; }
    </script>
</body>
</html>
